$.fn.focus=function(b,h){if(this[0]){if(1<=arguments.length&&Array.prototype.every.call(arguments,function(b){return Math.floor(b)===b}))if(this[0].setSelectionRange)try{return this[0].setSelectionRange(b,h||b)}catch(l){}else{if(this[0].createTextRange){var e=this[0].createTextRange();e.collapse(!0);e.moveEnd("character",h||b);e.moveStart("character",b);e.select()}}else if(2===arguments.length)return this.on("focus",null,b,h);return this.trigger("focus")}};
$.fn.visualquery=function(b){b=$.extend({strict:!1,parameters:[],defaultQuery:[],placeholder:"",callback:$.noop()},b);var h=function(){b.callback(g.list.map(function(a){return a.validate()&&{name:a.name.val(),operator:f[a.name.val()+"_operators"]&&f[a.name.val()+"_operators"][a.operator.val()]||a.operator.val(),value:f[a.name.val()+"_values"]&&f[a.name.val()+"_values"][a.value.val()]||a.value.val()}}).filter(function(a){return a}))},l=$("<div></div>",{"class":"placeholder",style:"pointer-events: none;"+
(b.defaultQuery.length?"display:none":""),text:b.placeholder}),e=$("<div>",{"class":"parameters",html:l}).on({focusin:function(){e.addClass("selected")},focusout:function(){e.removeClass("selected")},mousedown:function(a){if($(a.target).is(e)){a.preventDefault();$("div.parameter.selected",e).removeClass("selected");var b;$("div.parameter",e).each(function(){var c=$(this),d=c.offset();if(d.top>a.pageY||d.top<a.pageY&&a.pageY<d.top+c.height()&&d.left>a.pageX)return!1;b=c});var f=new m;f.$[void 0!==
b?"insertAfter":"prependTo"](b||this);f.name.focus();g.update()}}}),g={list:[],update:function(){var a=this,b=e.children("div.parameter");this.list=[];l[b.length?"hide":"show"]();b.each(function(){a.list.push($(this).data("Parameter"))});return this}},n={},f={names:[]};b.parameters.forEach(function(a){n[a.name]=a;f.names.push(a.name);f[a.name+"_operators"]=a.operators&&a.operators;f[a.name+"_values"]=a.values&&a.values});var k=function(){var a,b,e,c=$("<ul>",{"class":"autoComplete"}).css({position:"absolute",
display:"none"}).on("mouseover","li",function(){var d=$(this).addClass("selected");d.siblings(".selected").removeClass("selected");a.attr("placeholder",d.attr("value")).trigger("adjustWidth")}).on("mousedown","li",function(d){d.preventDefault();a.removeAttr("placeholder").val($(this).attr("value")).trigger("input").blur().next().focus()}),d=function(){console.log(c.children());var d=c.children(".selected").index(),r=-1!==d?d:0,d=b.map(function(d,c){if(d.match(new RegExp(a.val(),"i")))return $("<li>",
{text:d,"class":r===c?a.attr("placeholder",d).trigger("adjustWidth")&&"selected":""}).attr("value",d)}).filter(function(a){return a});e=e||parseInt(c.find("li").css("padding-left"));return d.length?c.html(d).show():c.hide()};return{$:c,targetInput:function(b){return(a=$(b).on({input:d.bind(this),blur:function(){$(this).unbind("keydown input")},keydown:function(a){var d=$(this),b;13===a.keyCode&&(a.preventDefault(),a=c.is(":visible")&&1===(b=c.children(".selected")).length&&d.val(b.attr("value")).trigger("input"),
d.blur().next().focus());if(c.is(":visible")&&(40===a.keyCode||38===a.keyCode))return a.preventDefault(),a=40===a.keyCode?"next":"prev",(b=c.children(".selected"))[a]().length&&(b=b.removeClass("selected")[a]().addClass("selected"))&&d.attr("placeholder",b.attr("value")).trigger("adjustWidth")}}))&&this},setLis:function(a){return(b=$.isArray(a)?a:Object.keys(a))&&d()&&this},show:function(d){0!==b.length&&c.show().offset({top:d.top+a.height(),left:d.left-(e||0)})}}}(),p=function(a){try{return 0===
a.selectionStart&&0===a.selectionEnd}catch(b){return!1}},q=function(a,b){try{return a.val().length===b.selectionStart&&a.val().length===b.selectionEnd}catch(e){return!1}},m=function(a,l,m){var c=this;this.remove=function(){c.$.remove();g.update();h()};this.validate=function(){var a=c.name.val(),e=c.operator.val(),f=c.value.val();return(a+e+f).length?a.length&&e.length&&f.length?b.strict&&!n.hasOwnProperty(a)?c.$.addClass("error").attr("title","Invalid Parameter")&&!1:c.value[0].checkValidity()?!0:
c.$.addClass("error").attr("title",c.value[0].validationMessage)&&!1:(c.$.addClass("error"),!1):c.remove()&&!1};this.$=$("<div>",{"class":"parameter"}).data("Parameter",this).append($("<span></span>",{id:"remove",html:"&times;"}).on("click",c.remove),this.name=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"name",value:a,style:"width:1px;"}).on({focus:function(){k.setLis(f.names).show($(this).offset())},blur:function(){var a=c.name.val(),a=n[a]||{};c.operator.attr(jQuery.extend({placeholder:""},
a.operatorAttrs||{},{type:"text"})).trigger("input");c.value.attr(jQuery.extend({placeholder:""},a.valueAttrs||{},{type:-1!==["text","email","number","url"].indexOf(a.type)&&a.type||"text"})).trigger("input")}}),this.operator=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"operator",value:l,style:"width:1px;"}).on("focus",function(){k.setLis(f[c.name.val()+"_operators"]||[]).show($(this).offset())}),this.value=$("<input>",{type:"text",spellcheck:"false",autoComplete:"off",id:"value",
value:m,style:"width:10px;"}).on("focus",function(){k.setLis(f[c.name.val()+"_values"]||[]).show($(this).offset())})).on("keydown","input#name",function(a){p(this)&&37===a.keyCode&&(a.preventDefault(),(a=g.list[g.list.indexOf(c)-1])&&a.value.focus())}).on("keydown","input#value",function(a){q($(this),this)&&39===a.keyCode&&(a.preventDefault(),(a=g.list[g.list.indexOf(c)+1])&&a.name.focus(0))}).on({keydown:function(a){var b=$(this);q(b,this)&&39===a.keyCode&&(a.preventDefault(),b.next().focus(0));
!p(this)||37!==a.keyCode&&8!==a.keyCode||(a.preventDefault(),b.prev().focus())},blur:function(){c.$.removeClass("selected");c.validate();k.$.hide();h()},focus:function(){c.$.removeClass("error").addClass("selected");k.targetInput(this)},"input adjustWidth":function(){var a=$(this),c=a.val(),c=0!==c.length?c:a.attr("placeholder")||"",c=$("<span>",{"class":b["class"]}).css(jQuery.extend({position:"absolute",width:"auto",visibility:"hidden",whiteSpace:"pre"},a.css("font-size font-family font-weight font-style font-variant word-spacing letter-spacing text-indent text-rendering text-transform".split(" ")))).text(c).appendTo(e),
f=c.width();c.remove();a.width((f||10)+1+({number:17}[a.attr("type")]||0))}},"input")};this.html([e,k.$]);b.defaultQuery.forEach(function(a){if(!b.strict||a.name in n)a=new m(a.name,a.operator,a.value,a.type),a.$.appendTo(e),a.name.trigger("blur").trigger("adjustWidth"),a.operator.trigger("adjustWidth"),a.value.trigger("adjustWidth"),g.update()});h()};
